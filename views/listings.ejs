<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>All Listings</title>

   <!-- font awesome cdn link  -->
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

   <!-- custom css file link  -->
   <link rel="stylesheet" href="css/style.css">

   <style>
      .cache-indicator {
         position: fixed;
         top: 80px;
         right: 20px;
         background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         color: white;
         padding: 10px 15px;
         border-radius: 8px;
         font-size: 0.9rem;
         box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
         z-index: 1000;
         display: none;
         animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
         from {
            transform: translateX(100%);
            opacity: 0;
         }

         to {
            transform: translateX(0);
            opacity: 1;
         }
      }

      .cache-indicator.show {
         display: block;
      }

      .cache-indicator i {
         margin-right: 8px;
      }
   </style>

</head>

<body>

   <!-- header section starts  -->
   <%- include('partials/header') %>

      <!-- Cache indicator -->
      <div class="cache-indicator" id="cache-indicator">
         <i class="fas fa-check-circle"></i>
         <span id="cache-message">Data cached in browser</span>
      </div>

      <!-- header section ends -->

      <!-- listings section starts  -->

      <section class="listings">

         <h1 class="heading">all listings</h1>

         <div class="box-container" id="properties-container">
            <% if (properties && properties.length> 0) { %>
               <% properties.forEach(property=> { %>
                  <div class="box">
                     <div class="admin">
                        <h3>
                           <%= property.owner.username.charAt(0).toUpperCase() %>
                        </h3>
                        <div>
                           <p>
                              <%= property.owner.name || property.owner.username %>
                           </p>
                           <span>
                              <%= new Date(property.createdAt).toLocaleDateString() %>
                           </span>
                        </div>
                     </div>
                     <div class="thumb">
                        <p class="type">
                           <span>
                              <%= property.type %>
                           </span>
                           <span>
                              <%= property.offerType %>
                           </span>
                        </p>
                        <img src="images/<%= property.image %>" alt="<%= property.title %>">
                     </div>
                     <h3 class="name">
                        <%= property.title %>
                     </h3>
                     <p class="location"><i class="fas fa-map-marker-alt"></i><span>
                           <%= property.location %>
                        </span></p>
                     <div class="flex">
                        <p><i class="fas fa-bed"></i><span>
                              <%= property.bedrooms %>
                           </span></p>
                        <p><i class="fas fa-bath"></i><span>
                              <%= property.bathrooms %>
                           </span></p>
                        <p><i class="fas fa-maximize"></i><span>
                              <%= property.area %>sqft
                           </span></p>
                     </div>
                     <div class="flex"
                        style="justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <p style="font-size: 1.2rem; font-weight: bold; color: #2c6bed;">₹<%=
                              property.price.toLocaleString() %>
                        </p>
                        <p style="font-size: 0.9rem;">
                           <%= property.status %>
                        </p>
                     </div>
                     <a href="/view-property/<%= property._id %>" class="btn">view property</a>
                  </div>
                  <% }); %>
                     <% } else { %>
                        <div style="text-align: center; width: 100%; padding: 20px;">
                           <p>No properties found. Be the first to add a property listing!</p>
                           <a href="/dashboard" class="btn" style="margin-top: 10px;">Add Property</a>
                        </div>
                        <% } %>
         </div>

      </section>

      <!-- listings section ends -->

      <!-- footer section starts  -->
      <%- include('partials/footer') %>

         <!-- footer section ends -->


         <!-- custom js file link  -->
         <script src="js/script.js"></script>

         <script>
            // Browser caching for listings page
            (function () {
               const CACHE_KEY = 'listings_page_data';
               const CACHE_DURATION = 15; // minutes

               // Get current properties data from the page
               const propertiesContainer = document.getElementById('properties-container');
               const propertiesHTML = propertiesContainer ? propertiesContainer.innerHTML : null;

               // Function to show cache indicator
               function showCacheIndicator(message, duration = 3000) {
                  const indicator = document.getElementById('cache-indicator');
                  const messageSpan = document.getElementById('cache-message');
                  messageSpan.textContent = message;
                  indicator.classList.add('show');

                  setTimeout(() => {
                     indicator.classList.remove('show');
                  }, duration);
               }

               // Check if we loaded from cache
               const cachedData = BrowserCache.getLocal(CACHE_KEY);
               if (cachedData && cachedData.html === propertiesHTML) {
                  console.log('[Browser Cache] Loaded from cache');
                  showCacheIndicator('✓ Loaded from browser cache');
               } else {
                  console.log('[Browser Cache] Fresh data, caching now');

                  // Cache the current page data
                  if (propertiesHTML) {
                     BrowserCache.setLocal(CACHE_KEY, {
                        html: propertiesHTML,
                        timestamp: Date.now(),
                        url: window.location.pathname
                     }, CACHE_DURATION);

                     showCacheIndicator('✓ Data cached for 15 minutes');
                  }
               }

               // Also cache metadata
               BrowserCache.setLocal('last_visited_listings', {
                  timestamp: Date.now(),
                  propertyCount: document.querySelectorAll('.box').length
               }, CACHE_DURATION);

               console.log('[Browser Cache] Listings page data cached in localStorage');
            })();
         </script>

</body>

</html>